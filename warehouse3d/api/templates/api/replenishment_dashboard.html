{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Replenishment Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        background: #0e1117;
        color: #e5e7eb;
      }
      .card {
        background: #161b22;
        border: 1px solid #1f2933;
        border-radius: 12px;
      }
      .kpi {
        font-size: 28px;
        font-weight: 700;
      }
      .form-control {
        background: #0e1117;
        color: #e5e7eb;
        border: 1px solid #2f3a42;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid p-4">
      <h3 class="mb-4">ðŸ“¦ Replenishment Analytics</h3>

      <!-- Upload -->
      <div class="card p-3 mb-4">
        <form method="post" enctype="multipart/form-data" class="d-flex gap-3 align-items-center">
          {% csrf_token %}
          <input type="file" name="file" class="form-control" required />
          <button class="btn btn-primary">Upload</button>
        </form>
      </div>

      {% if kpi %}
      <!-- KPI Cards -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card p-3 text-center">
            <div class="text-danger kpi">{{ kpi.critical }}</div>
            <div>Critical</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 text-center">
            <div class="text-warning kpi">{{ kpi.warning }}</div>
            <div>Reorder Soon</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 text-center">
            <div class="text-success kpi">{{ kpi.ok }}</div>
            <div>Healthy</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 text-center">
            <div class="text-info kpi">{{ kpi.total_moves }}</div>
            <div>Total Moves</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="card p-3">
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#barTab">ðŸ“Š Critical Stock</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pieTab">ðŸ¥§ Status Split</button>
          </li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="barTab">
            <canvas id="barChart" height="120"></canvas>
          </div>
          <div class="tab-pane fade" id="pieTab">
            <canvas id="pieChart" height="120"></canvas>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {% if chart_data %}
    <script>
      const barData = {{ chart_data.bar|default:"null"|safe }};
      const pieData = {{ chart_data.pie|safe }};

      // BAR CHART
      if (barData) {
        const barCtx = document.getElementById("barChart").getContext("2d");
        new Chart(barCtx, {
          type: "bar",
          data: {
            labels: barData.labels,
            datasets: [
              {
                label: "Current Qty",
                data: barData.current,
                backgroundColor: "#f6a04d"
              },
              {
                label: "Reorder Qty",
                data: barData.reorder,
                backgroundColor: "#4e73df"
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: "#e5e7eb" } }
            },
            scales: {
              x: { ticks: { color: "#e5e7eb" } },
              y: { ticks: { color: "#e5e7eb" } }
            }
          }
        });
      }

      // PIE CHART
      const pieCtx = document.getElementById("pieChart").getContext("2d");
      new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: Object.keys(pieData),
          datasets: [
            {
              data: Object.values(pieData),
              backgroundColor: ["#dc3545", "#ffc107", "#198754"]
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" }
            }
          }
        }
      });
    </script>
    {% endif %}
  </body>
</html>
